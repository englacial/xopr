name: CodSpeed Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: read

jobs:
  bench-cpu:
    name: "Benchmarks (CPU simulation)"
    # Run on: main push (baseline), PR with label, or /benchmark comment
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'run-benchmarks')) ||
      (github.event_name == 'pull_request' &&
       github.event.action == 'labeled' &&
       github.event.label.name == 'run-benchmarks') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/benchmark'))
    runs-on: ubuntu-latest
    steps:
    - name: Get PR ref (for comment trigger)
      id: pr-ref
      if: github.event_name == 'issue_comment'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          core.setOutput('ref', pr.head.sha);

          await github.rest.reactions.createForIssueComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: context.payload.comment.id,
            content: 'rocket'
          });

    - uses: actions/checkout@v4
      with:
        ref: ${{ steps.pr-ref.outputs.ref || github.sha }}

    - uses: astral-sh/setup-uv@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install dependencies
      run: uv sync --extra bench

    - name: Run CPU benchmarks
      uses: CodSpeedHQ/action@v3
      with:
        run: uv run pytest src/xopr/tests/test_bench_cpu.py --codspeed -o "addopts="

  bench-walltime:
    name: "Benchmarks (walltime, macro runner)"
    # Macro runners cost minutes â€” only run on main push and /benchmark comment
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/benchmark'))
    runs-on: codspeed-macro
    steps:
    - name: Get PR ref (for comment trigger)
      id: pr-ref
      if: github.event_name == 'issue_comment'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          core.setOutput('ref', pr.head.sha);

          await github.rest.reactions.createForIssueComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            comment_id: context.payload.comment.id,
            content: 'rocket'
          });

    - uses: actions/checkout@v4
      with:
        ref: ${{ steps.pr-ref.outputs.ref || github.sha }}

    - uses: astral-sh/setup-uv@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Install dependencies
      run: uv sync --extra bench

    - name: Run walltime benchmarks
      uses: CodSpeedHQ/action@v3
      with:
        mode: walltime
        run: >
          uv run pytest src/xopr/tests/test_bench_walltime.py
          --codspeed --codspeed-warmup-time=1.0
          -o "addopts="
