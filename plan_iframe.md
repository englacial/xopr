# Plan: Embed pdoc API docs via iframe in MyST site (Issue #67)

## Problem

Users clicking "API Docs" in the MyST site at docs.englacial.org/xopr are
taken to a separate pdoc page (`/xopr/api/xopr.html`) with no navigation back
to the main docs. Issue #67 asks us to consolidate everything in one place.

## What we tried (branch `67-consolidate-api-docs`)

We attempted a `sphinx-ext-mystmd` bridge (Sphinx autodoc → MyST JSON AST →
inline rendering). This is alpha-level software and the results were poor:

- **Broken signature formatting**: parameter commas rendered on their own lines;
  the AST puts `, ` as bare text nodes between `<em>` elements, making CSS-only
  fixes fragile/impossible
- **No syntax highlighting** on signatures or code examples
- **No "view source" links** — would require upstream `sphinx-ext-mystmd` changes
- **Overall quality far below pdoc**, which has proper formatting, highlighting,
  navigation, and source links out of the box

**Conclusion**: `sphinx-ext-mystmd` is not ready. The branch has the experimental
code but should not be merged. Revisit when upstream matures (track
`jupyter-book/sphinx-ext-mystmd` and `jupyter-book/mystmd#1259`).

## Proposed approach: iframe embedding

Keep pdoc (it works great) but embed it inside a MyST page so users stay in
the MyST site navigation. We already have a working pattern for this — the
`polar-map` directive in `docs/iframe-map.mjs` embeds an iframe for interactive
maps.

### How it works

1. pdoc builds API HTML as it does today → `docs/_build/html/api/`
2. A new MyST page `docs/api.md` uses an iframe pointing to the pdoc output
3. The MyST TOC references `api.md` as a normal page (not an external URL)
4. Users see the API docs inline within the MyST site chrome (sidebar, header)

### Files to create/modify

| File | Action | Purpose |
|------|--------|---------|
| `docs/iframe-api.mjs` | **Create** | MyST plugin: `api-docs` directive that renders an iframe |
| `docs/api.md` | **Create** | Page that uses the `api-docs` directive |
| `docs/myst.yml` | **Modify** | Register plugin, replace external URL TOC entry with `file: api.md` |
| `.github/workflows/docs.yml` | **Modify** | Reorder: build pdoc *before* MyST so iframe src exists at build time |

No changes needed to `pyproject.toml` (pdoc is already a dependency).

### Implementation details

#### 1. `docs/iframe-api.mjs`

Simple MyST plugin modeled on the existing `iframe-map.mjs`:

```javascript
const apiDocsDirective = {
  name: 'api-docs',
  doc: 'Embed pdoc API documentation in an iframe',
  arg: {
    type: String,
    doc: 'Path to pdoc HTML (default: /xopr/api/xopr.html)',
    required: false
  },
  options: {
    width: { type: String, doc: 'CSS width' },
    height: { type: String, doc: 'CSS height' },
    module: {
      type: String,
      doc: 'Jump to a specific module page (e.g., "geometry" → /xopr/api/xopr/geometry.html)'
    }
  },
  run(data) {
    const { arg: src, options = {} } = data;

    let url = src || '/xopr/api/xopr.html';
    if (options.module) {
      url = `/xopr/api/xopr/${options.module}.html`;
    }

    return [{
      type: 'iframe',
      src: url,
      width: options.width || '100%',
      height: options.height || '80vh',
      frameborder: '0',
      style: 'border: 1px solid #eee; border-radius: 4px;',
      id: `api-docs-${Math.random().toString(36).substr(2, 9)}`
    }];
  }
};

const plugin = {
  name: 'API docs iframe plugin',
  directives: [apiDocsDirective]
};

export default plugin;
```

#### 2. `docs/api.md`

```markdown
# API Reference

Full API documentation for xopr, generated by [pdoc](https://pdoc.dev/).

:::{api-docs}
:width: 100%
:height: 80vh
:::
```

#### 3. `docs/myst.yml` changes

Register the new plugin and swap the TOC entry:

```yaml
# In project.plugins, add:
  plugins:
    - ./iframe-map.mjs
    - ./iframe-api.mjs    # <-- add this

# In project.toc, replace:
#   - title: API Docs
#     url: /xopr/api/xopr.html
# with:
    - file: api.md
```

#### 4. `.github/workflows/docs.yml` changes

Move the pdoc build step **before** the MyST build, so the API HTML exists
when MyST renders the iframe (and so the pdoc output is included in the
`_build/html/` directory before MyST copies its output):

```yaml
    - name: Build API Documentation with pdoc
      run: |
        mkdir -p docs/_build/html/api
        uv run --extra docs --extra stac pdoc -o docs/_build/html/api --docformat numpy src/xopr
        echo "API documentation generated at docs/_build/html/api/"

    - name: Build MyST Documentation
      run: |
        cd docs
        BASE_URL=/xopr uv run --extra docs myst build --html --execute 2>&1 | tee myst-build.log
        ...
```

**Important**: The MyST build currently copies output from `_build/site/public`
to `_build/html`. If pdoc writes to `_build/html/api/` first, the subsequent
`cp -r _build/site/public/* _build/html/` won't clobber the `api/` subdirectory
(cp merges, it doesn't delete). Verify this in testing.

### Build order (CI)

```
1. uv sync --extra docs --extra stac
2. pdoc → docs/_build/html/api/          (API HTML)
3. myst build --html → docs/_build/html/  (narrative + notebooks, merges over)
4. Upload docs/_build/html/ to Pages
```

### Build order (local development)

```bash
# One-time: generate API docs
uv run --extra docs --extra stac pdoc -o docs/_build/html/api --docformat numpy src/xopr

# Start MyST dev server (api.md iframe will point to /xopr/api/xopr.html)
cd docs && uv run --extra docs myst start
```

**Note for local dev**: `myst start` serves from its own dev server on port
3000, but the iframe `src="/xopr/api/xopr.html"` needs the pdoc HTML to be
accessible at that path. Two options:

- **Option A**: Use a relative path in the directive (`./api/xopr.html`) and
  symlink `docs/api → docs/_build/html/api` for local dev
- **Option B**: Use the full deployed URL in dev mode and only use the relative
  path in CI (configure via env var or directive argument)
- **Option C** (simplest): During local dev, just open the pdoc output directly
  (`open docs/_build/html/api/xopr.html`) — the iframe is mainly for the
  deployed site experience

Option A is probably cleanest. Test during implementation.

### Known considerations

1. **pdoc's fixed sidebar**: pdoc uses `position: fixed` and `height: 100vh`
   for its navigation sidebar. Inside an iframe these are relative to the
   iframe's viewport, so they should work correctly — the iframe is its own
   browsing context.

2. **iframe height**: `80vh` is a reasonable default. pdoc pages can be long;
   users will scroll within the iframe. Could experiment with auto-resizing
   via `postMessage`, but that's over-engineering for now.

3. **Deep linking**: The `module` option on the directive allows linking
   directly to submodule pages (e.g., `geometry`, `stac`). For the main
   API page, the default works.

4. **Search**: pdoc has its own search within the iframe. MyST's search won't
   index the iframe content — this is acceptable.

5. **Mobile**: The iframe approach may be cramped on narrow screens. Consider
   adding a "Open in new tab" link below the iframe for mobile users.

### Cleanup

When implementing this, also:
- Revert all changes from branch `67-consolidate-api-docs` (sphinx-ext-mystmd
  approach) — do NOT merge that branch
- Remove `sphinx>=6.2`, `myst-parser`, `sphinx-ext-mystmd` from pyproject.toml
  `[docs]` extra (these were added on the experimental branch)
- Remove `[tool.hatch.metadata] allow-direct-references` if no other dep needs it
- Delete `docs/conf.py` and `docs/sphinx-api.css` (from the experimental branch)
- Keep pdoc in `[docs]` dependencies (it's the engine)

### Future

When `mystmd` gains native API doc support (track `jupyter-book/mystmd#1259`),
replace the iframe with native rendering. The iframe is a pragmatic bridge, not
the end state.
